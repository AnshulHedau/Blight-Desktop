<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="https://www.gstatic.com/firebasejs/4.11.0/firebase.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>

    <title>Blight - Report</title>

    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyBbGWcyla5IKW8s6M7IRhne2d02QzGOYmw",
            authDomain: "blight-c675c.firebaseapp.com",
            databaseURL: "https://blight-c675c.firebaseio.com",
            projectId: "blight-c675c",
            storageBucket: "blight-c675c.appspot.com",
            messagingSenderId: "286025009005"
        };
        firebase.initializeApp(config);
    </script>
</head>

<body>
  <div id = "title">
    Blight Report - 00/00/0000
  </div>

  <div id = "location">
    Vellore
  </div>

  <div id = "print_button">
    <form>
         <input type="button" value="Print" onclick="window.print()" />
      </form>
  </div>

  <div id = "total_alerts">
    Total alerts issued by the center: <span id = "total_alerts_number">-</span>
  </div>

  <div id = "month_alerts">
    Alerts issued in last 30 days: <span id = "month_alert_number">-</span>
  </div>

  <div id = "total_help">
    Total help calls by the users: <span id = "total_help_number">-</span>
  </div>

  <div id = "month_help">
    Help calls in the last 30 days: <span id = "month_help_number">-</span>
  </div>

  <div id = "total_active">
    Active help(s) calls: <span id = "active_help_number">-</span>
  </div>

  <canvas id="myChart" width="400" height="400"></canvas>
</body>

<script>
  var date = new Date();
  var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
  var report_date = date.getDate() + " " + months[date.getMonth()] + " " + date.getFullYear();

  document.getElementById('title').innerHTML = "Blight Report - " + report_date;

  var alertRef = firebase.database().ref('alert_history_log/').on('value', function(snapshot) {
      var alerts = snapshot.numChildren();
      document.getElementById("total_alerts_number").innerHTML = alerts;
      var month_alert_count = 0;
      var date = new Date();
      var request_millis = date.getTime();

      var Earthquakes = 0;
      var Thunderstorms = 0;
      var Floods = 0;
      var Forest_Fires = 0;

      for (i = 0; i < alerts; i++) {
        var object_key = Object.keys(snapshot.val())[i];

        var singlealertRef = firebase.database().ref("alert_history_log/" + object_key);
        singlealertRef.on('value', function(snapshot) {
            // Counting the last alerts in 30 days
            millis = snapshot.val().alert_millis;
            if ((request_millis - 2592000000) < millis) {
              month_alert_count += 1;
            }
            document.getElementById("month_alert_number").innerHTML = month_alert_count;

            // Counting the types of calamities
            if (snapshot.val().alert_type == "Flood") {
              Floods += 1;
            }

            if (snapshot.val().alert_type == "Thunderstorm") {
              Thunderstorms += 1;
            }

            if (snapshot.val().alert_type == "Forest Fire") {
              Forest_Fires += 1;
            }

            if (snapshot.val().alert_type == "Earthquake") {
              Earthquakes += 1;
            }

            var myRadarChart = new Chart(ctx, {
              "type": "radar",
              "data": {
                  "labels": ["Earthquakes", "Thunderstorms", "Floods", "Forest Fires"],
                  "datasets": [{
                      "label": "Types of calamities",
                      "data": [Earthquakes, Thunderstorms, Floods, Forest_Fires],
                      "fill": true,
                      "backgroundColor": "rgba(255, 99, 132, 0.2)",
                      "borderColor": "rgb(255, 99, 132)",
                      "pointBackgroundColor": "rgb(255, 99, 132)",
                      "pointBorderColor": "#fff",
                      "pointHoverBackgroundColor": "#fff",
                      "pointHoverBorderColor": "rgb(255, 99, 132)"
                  }]
              },
              "options": {
                "scale": {
                  "ticks": {
                    "min": 0,
                    "stepSize": 1
                  },
                  "pointLabels": {
                    "fontSize": 12
                  }
                },
                "legend": {
                  position: 'right'
                }
              }
          });
        });
      }
  });

  var helpRef = firebase.database().ref('help_requests_log/').on('value', function(snapshot) {
      var helps = snapshot.numChildren();
      document.getElementById("total_help_number").innerHTML = helps;

      month_help_count = 0;
      var date = new Date();
      var request_millis = date.getTime();

      for (i = 0; i < helps; i++) {
        var object_key = Object.keys(snapshot.val())[i];

        var singlealertRef = firebase.database().ref("help_requests_log/" + object_key);
        singlealertRef.on('value', function(snapshot) {
            millis = snapshot.val().alert_millis;

            if ((request_millis - 2592000000) < Number(millis)) {
              month_help_count += 1;
            }
            document.getElementById("month_help_number").innerHTML = month_help_count;
        });
      }
  });

  var activeRef = firebase.database().ref('alerts/').on('value', function(snapshot) {
      var alerts = snapshot.numChildren();
      document.getElementById("active_help_number").innerHTML = alerts;
  });
</script>

<script>
  var ctx = document.getElementById("myChart");
</script>
